<!DOCTYPE html>
<html>
    <head>
        <title>
            Plugins
        </title>

        <meta http-equiv="content-type" content="text/html; charset=utf-8"/>

        <link href="../../../3rdparty/googleCodePrettify/prettify.css" rel="stylesheet" type="text/css"/>
        <link href="../../res/stylesheet.css" rel="stylesheet" type="text/css"/>

        <script src="../../../3rdparty/googleCodePrettify/prettify.js" type="text/javascript"></script>
        <script src="../../../3rdparty/jQuery/jquery.js" type="text/javascript"></script>
        <script src="../../../res/common.js" type="text/javascript"></script>
        <script src="../../res/menu.js" type="text/javascript"></script>
    </head>
    <body onload="prettyPrint();" ondragstart="return false;" ondrop="return false;">
        <script type="text/javascript">
            headerAndContentsMenu("Plugins", "../../..");
        </script>

        <p>
            To help you get started, you might want to have a look at the following sample plugins. They illustrate the basic concepts needed to develop plugins for OpenCOR:
        </p>

        <ul>
            <li><a href="Sample.html">Sample</a></li>
            <li><a href="SampleTools.html">SampleTools</a></li>
            <li><a href="SampleView.html">SampleView</a></li>
            <li><a href="SampleWindow.html">SampleWindow</a></li>
        </ul>

        <p class="note">
            these plugins only get built if the <a href="https://www.cmake.org/">CMake</a> <code>ENABLE_SAMPLES</code> option is set to <code>ON</code>.
        </p>

        <span class="anchor" id="Category"></span>

        <div class="section">
            Category
        </div>

        <p>
            All plugins come under a given category. Currently supported categories are:
        </p>

        <ul>
            <li><strong>Analysis:</strong> plugins to analyse files.</li>
            <li><strong>API:</strong> plugins to access various APIs.</li>
            <li><strong>Data Store:</strong> plugins to store and manipulate data.</li>
            <li><strong>Editing:</strong> plugins to edit files.</li>
            <li><strong>Miscellaneous:</strong> plugins that do not fit in any other category.</li>
            <li><strong>Organisation:</strong> plugins to organise files.</li>
            <li><strong>Sample:</strong> plugins that illustrate various plugin-related aspects.</li>
            <li><strong>Simulation:</strong> plugins to simulate files.</li>
            <li><strong>Solver:</strong> plugins to access various solvers.</li>
            <li><strong>Support:</strong> plugins to support various third-party libraries and APIs.</li>
            <li><strong>Third-party:</strong> plugins to access various third-party libraries.</li>
            <li><strong>Tool:</strong> plugins to access various tools.</li>
            <li><strong>Widget:</strong> plugins to access various <em>ad hoc</em> widgets.</li>
        </ul>

        <p>
            A category is used by OpenCOR to group plugins together to improve user experience. From a developer's perspective, a category determines where a plugin's code should be located. Thus, the different folders under <a href="https://github.com/opencor/opencor/blob/master/src/plugins/"><code>[OpenCOR]/src/plugins/</code></a> are for our different categories. For example, <a href="https://github.com/opencor/opencor/blob/master/src/plugins/miscellaneous/"><code>[OpenCOR]/src/plugins/miscellaneous/</code></a> contains the code of our different <strong>Miscellaneous</strong> plugins and <a href="https://github.com/opencor/opencor/blob/master/src/plugins/miscellaneous/Core/"><code>[OpenCOR]/src/plugins/miscellaneous/Core/</code></a> that of the <strong>Core</strong> plugin in particular.
        </p>

        <p class="note">
            the <strong>Sample</strong> category is a special category in that it is only available when building OpenCOR with the <a href="https://www.cmake.org/">CMake</a> <code>ENABLE_SAMPLES</code> option set to <code>ON</code>. It should therefore only be used for plugins that are aimed at helping people who want to learn how to write plugins for OpenCOR.
        </p>

        <span class="anchor" id="Interfaces"></span>

        <div class="section">
            Interfaces
        </div>

        <p>
            Plugins can implement different interfaces. Those interfaces allow a plugin, through the implementation of various methods, to interact with OpenCOR. Currently supported interfaces can be found under <a href="https://github.com/opencor/opencor/blob/master/src/plugins/"><code>[OpenCOR]/src/plugins/</code></a>. They are:
        </p>

        <ul>
            <li><strong><a href="https://github.com/opencor/opencor/blob/master/src/plugins/cliinterface.inl">CLI</a>:</strong> to support command line execution.</li>
            <li><strong><a href="https://github.com/opencor/opencor/blob/master/src/plugins/coreinterface.inl">Core</a>:</strong> to control some of OpenCOR's core aspects.</li>
            <li><strong><a href="https://github.com/opencor/opencor/blob/master/src/plugins/datastoreinterface.inl">Data store</a>:</strong> to let OpenCOR know about the name of our data store, as well as to provide OpenCOR with a new instance of that data store.</li>
            <li><strong><a href="https://github.com/opencor/opencor/blob/master/src/plugins/filehandlinginterface.inl">File handling</a>:</strong> to save a file, as well as to be told whenever a file has been opened, modified, closed, etc.</li>
            <li><strong><a href="https://github.com/opencor/opencor/blob/master/src/plugins/filetypeinterface.inl">File type</a>:</strong> to let OpenCOR know about our supported file types and their description.</li>
            <li><strong><a href="https://github.com/opencor/opencor/blob/master/src/plugins/guiinterface.inl">GUI</a>:</strong> to let OpenCOR know about the menus and menu actions that we want to see added to the <a href="https://en.wikipedia.org/wiki/Graphical_user_interface">GUI</a>, as well as to be told whenever the <a href="https://en.wikipedia.org/wiki/Graphical_user_interface">GUI</a> needs updating.</li>
            <li><strong><a href="https://github.com/opencor/opencor/blob/master/src/plugins/i18ninterface.inl">Internationalisation</a>:</strong> to be told whenever we should retranslate ourselves.</li>
            <li><strong><a href="https://github.com/opencor/opencor/blob/master/src/plugins/plugininterface.inl">Plugin</a>:</strong> to initialise/finalise a plugin, load/save its settings, etc.</li>
            <li><strong><a href="https://github.com/opencor/opencor/blob/master/src/plugins/solverinterface.inl">Solver</a>:</strong> to let OpenCOR know about the type, name and properties of our solver, as well as to provide OpenCOR with a new instance of that solver.</li>
            <li><strong><a href="https://github.com/opencor/opencor/blob/master/src/plugins/viewinterface.inl">View</a>:</strong> to let OpenCOR know about the name of our view, its mode, the MIME types it supports, whether we have a view for the current file, etc.</li>
            <li><strong><a href="https://github.com/opencor/opencor/blob/master/src/plugins/windowinterface.inl">Window</a>:</strong> to let OpenCOR know about the widget, action and default location of our window.</li>
        </ul>

        <p>
            Some plugins do not implement any interface (e.g. the <strong>LLVM</strong> plugin) while others may implement one or several interfaces (e.g. the <strong>Core</strong> plugin implements the <a href="https://github.com/opencor/opencor/blob/master/src/plugins/coreinterface.inl">core</a>, <a href="https://github.com/opencor/opencor/blob/master/src/plugins/filehandlinginterface.inl">file handling</a>, <a href="https://github.com/opencor/opencor/blob/master/src/plugins/guiinterface.inl">GUI</a>, <a href="https://github.com/opencor/opencor/blob/master/src/plugins/i18ninterface.inl">internationalisation</a> and <a href="https://github.com/opencor/opencor/blob/master/src/plugins/plugininterface.inl">plugin</a> interfaces).
        </p>

        <p class="note">
            the <a href="https://github.com/opencor/opencor/blob/master/src/plugins/coreinterface.inl">core</a> interface is a special interface in that it is only, and can only be, implemented by the <strong>Core</strong> plugin. Any plugin, besides the <strong>Core</strong> plugin, that tries to implement the <a href="https://github.com/opencor/opencor/blob/master/src/plugins/coreinterface.inl">core</a> interface will be reported by OpenCOR as being invalid.
        </p>

        <span class="anchor" id="CMake project"></span>

        <div class="section">
            CMake project
        </div>

        <p>
            OpenCOR is built and packaged using <a href="https://www.cmake.org/">CMake</a>. When it comes to plugins, this requires creating a <code>CMakeLists.txt</code> file in the plugin's root folder and calling the <code>ADD_PLUGIN()</code> macro, which is defined in <a href="https://github.com/opencor/opencor/blob/master/cmake/common.cmake"><code>[OpenCOR]/cmake/common.cmake</code></a>. The <code>ADD_PLUGIN()</code> macro uses information passed to it to build and package the plugin. That information comes in the form of a series of parameters, some of which are keywords:
        </p>

        <ul>
            <li><code>SOURCES</code>: implementation files.</li>
            <li><code>HEADERS_MOC</code>: header files, which define at least one <code>QObject</code>-based class.</li>
            <li><code>UIS</code>: user interface files.</li>
            <li><code>INCLUDE_DIRS</code>: various locations where header files can be found.</li>
            <li><code>DEFINITIONS</code>: definitions needed to build the plugin.</li>
            <li><code>PLUGINS</code>: plugins needed by the plugin.</li>
            <li><code>PLUGIN_BINARIES</code>: the binary version of plugins needed by the plugin.</li>
            <li><code>QT_MODULES</code>: <a href="https://www.qt.io/">Qt</a> modules needed by the plugin.</li>
            <li><code>EXTERNAL_BINARIES_DIR</code>: location where external binaries needed by the plugin can be found.</li>
            <li><code>EXTERNAL_BINARIES</code>: external binaries needed by the plugin.</li>
            <li><code>TESTS</code>: <a href="../tests.html">tests</a> for the plugin.</li>
        </ul>

        <p>
            Following those keywords are the parameters themselves, as can be seen in <a href="https://github.com/opencor/opencor/blob/master/src/plugins/miscellaneous/Core/CMakeLists.txt"><code>[OpenCOR]/src/plugins/miscellaneous/Core/CMakeLists.txt</code></a> for the <strong>Core</strong> plugin.
        </p>

        <span class="anchor" id="Plugin information"></span>

        <div class="section">
            Plugin information
        </div>

        <p>
            For a plugin to be recognisable by OpenCOR, it must provide some <a href="#Basic information">basic information</a> about itself, as well as define a <a href="#Plugin class">plugin class</a>. For this, we need a <code>.cpp</code>, a <code>.h</code> and <code>.json</code> file, such as <a href="https://github.com/opencor/opencor/blob/master/src/plugins/miscellaneous/Core/src/coreplugin.cpp"><code>[OpenCOR]/src/plugins/miscellaneous/Core/src/coreplugin.cpp</code></a>, <a href="https://github.com/opencor/opencor/blob/master/src/plugins/miscellaneous/Core/src/coreplugin.h"><code>[OpenCOR]/src/plugins/miscellaneous/Core/src/coreplugin.h</code></a> and <a href="https://github.com/opencor/opencor/blob/master/src/plugins/miscellaneous/Core/src/coreplugin.json"><code>[OpenCOR]/src/plugins/miscellaneous/Core/src/coreplugin.json</code></a> for the <strong>Core</strong> plugin.
        </p>

        <span class="anchor" id=".json file"></span>

        <div class="subSection">
            <code>.json</code> file
        </div>

        <p>
            The <code>.json</code> file is a simple <a href="http://www.json.org/">JSON</a> file, which sole purpose is to reference the name of the plugin class. In the case of the <strong>Core</strong> plugin, the contents of that file is:
        </p>

        <pre class="prettyprint">{
    "Keys": [ "CorePlugin" ]
}</pre>


        <div class="subSection">
            Namespace
        </div>

        <p>
            The code for the <a href="#Basic information">basic information</a> and <a href="#Plugin class">plugin class</a> must be in the plugin's own namespace within the <code>OpenCOR</code> namespace. More generally, any plugin-related code should be within those two namespaces, this to ensure the integrity of the plugin's code. Thus, in the case of the <strong>Core</strong> plugin, we must have:
        </p>

        <pre class="prettyprint">...
namespace OpenCOR {
namespace Core {
...
}   // namespace Core
}   // namespace OpenCOR
...</pre>

        <span class="anchor" id="Basic information"></span>

        <div class="subSection">
            Basic information
        </div>

        <p>
            Plugins must provide the following basic information about themselves:
        </p>

        <ul>
            <li><strong>Category:</strong> category under which the plugin is to be listed.</li>
            <li><strong>Selectable:</strong> whether the plugin can be selected by the user (for loading upon starting OpenCOR).</li>
            <li><strong><a href="https://en.wikipedia.org/wiki/Command-line_interface">CLI</a> support:</strong> whether the plugin works from the command line.</li>
            <li><strong>Dependencies:</strong> plugins on which the plugin depends directly.</li>
            <li><strong>Descriptions:</strong> description of the plugin in various languages.</li>
        </ul>

        <p>
            This information is made available to OpenCOR through a function, which in the case of the <strong>Core</strong> plugin has the following declaration:
        </p>

        <pre class="prettyprint">PLUGININFO_FUNC CorePluginInfo();</pre>

        <p class="note">
            to ensure the uniqueness of a plugin, OpenCOR uses the name of a plugin to determine the name of its function. In other words, the name of the function is expected to be <code>&lt;PluginName&gt;PluginInfo()</code>. If it is not, OpenCOR will not be able to recognise the plugin.
        </p>

        <p>
            In the case of the <strong>Core</strong> plugin, the body of its function is:
        </p>

        <pre class="prettyprint">PLUGININFO_FUNC CorePluginInfo()
{
    Descriptions descriptions;

    descriptions.insert("en", QString::fromUtf8("the core plugin."));
    descriptions.insert("fr", QString::fromUtf8("l'extension de base."));

    return new PluginInfo(PluginInfo::Miscellaneous, false, false,
                          QStringList(),
                          descriptions);
}</pre>

        <p class="note">
            support for the internationalisation of a plugin's description would normally be done using <a href="https://www.qt.io/">Qt</a>'s <code>tr()</code> function, but the C nature of the function means that it cannot be done. So, instead, we use a <code>QMap</code>-based approach.
        </p>

        <span class="anchor" id="Plugin class"></span>

        <div class="subSection">
            Plugin class
        </div>

        <p>
            We rely on <a href="https://www.qt.io/">Qt</a>'s support for plugins, which means that plugins must define a specific class. The class must inherit from <code>QObject</code>, as well as from any interface the plugin implements. For example, the <strong>Core</strong> plugin implements the <a href="https://github.com/opencor/opencor/blob/master/src/plugins/coreinterface.inl">core</a>, <a href="https://github.com/opencor/opencor/blob/master/src/plugins/filehandlinginterface.inl">file handling</a>, <a href="https://github.com/opencor/opencor/blob/master/src/plugins/guiinterface.inl">GUI</a>, <a href="https://github.com/opencor/opencor/blob/master/src/plugins/i18ninterface.inl">internationalisation</a> and <a href="https://github.com/opencor/opencor/blob/master/src/plugins/plugininterface.inl">plugin</a> interfaces, so its class definition is:
        </p>

        <pre class="prettyprint">...
class CorePlugin : public QObject, public <a href="https://github.com/opencor/opencor/blob/master/src/plugins/coreinterface.h">CoreInterface</a>,
                   public <a href="https://github.com/opencor/opencor/blob/master/src/plugins/filehandlinginterface.h">FileHandlingInterface</a>, public <a href="https://github.com/opencor/opencor/blob/master/src/plugins/guiinterface.h">GuiInterface</a>,
                   public <a href="https://github.com/opencor/opencor/blob/master/src/plugins/i18ninterface.h">I18nInterface</a>, public <a href="https://github.com/opencor/opencor/blob/master/src/plugins/plugininterface.h">PluginInterface</a>
{
    Q_OBJECT

    Q_PLUGIN_METADATA(IID "OpenCOR.CorePlugin" FILE "<a href="https://github.com/opencor/opencor/blob/master/src/plugins/miscellaneous/Core/src/coreplugin.json"><code>coreplugin.json</code></a>")

    Q_INTERFACES(OpenCOR::<a href="https://github.com/opencor/opencor/blob/master/src/plugins/coreinterface.h">CoreInterface</a>)
    Q_INTERFACES(OpenCOR::<a href="https://github.com/opencor/opencor/blob/master/src/plugins/filehandlinginterface.h">FileHandlingInterface</a>)
    Q_INTERFACES(OpenCOR::<a href="https://github.com/opencor/opencor/blob/master/src/plugins/guiinterface.h">GuiInterface</a>)
    Q_INTERFACES(OpenCOR::<a href="https://github.com/opencor/opencor/blob/master/src/plugins/i18ninterface.h">I18nInterface</a>)
    Q_INTERFACES(OpenCOR::<a href="https://github.com/opencor/opencor/blob/master/src/plugins/plugininterface.h">PluginInterface</a>)

public:
#include "<a href="https://github.com/opencor/opencor/blob/master/src/plugins/coreinterface.inl">coreinterface.inl</a>"
#include "<a href="https://github.com/opencor/opencor/blob/master/src/plugins/filehandlinginterface.inl">filehandlinginterface.inl</a>"
#include "<a href="https://github.com/opencor/opencor/blob/master/src/plugins/guiinterface.inl">guiinterface.inl</a>"
#include "<a href="https://github.com/opencor/opencor/blob/master/src/plugins/i18ninterface.inl">i18ninterface.inl</a>"
#include "<a href="https://github.com/opencor/opencor/blob/master/src/plugins/plugininterface.inl">plugininterface.inl</a>"
...
};
...</pre>

        <p>
            On the other hand, the <strong>LLVM</strong> plugin does not need to implement any interface since its sole purpose is to provide other plugins with access to <a href="http://www.llvm.org/">LLVM</a> (incl. <a href="http://clang.llvm.org/">Clang</a>). Hence, its much simpler class definition:
        </p>

        <pre class="prettyprint">...
class LLVMPlugin : public QObject
{
    Q_OBJECT

    Q_PLUGIN_METADATA(IID "OpenCOR.LLVMPlugin" FILE "<a href="https://github.com/opencor/opencor/blob/master/src/plugins/thirdParty/LLVM/src/llvmplugin.json"><code>llvmplugin.json</code></a>")
};
...</pre>

        <span class="anchor" id="Global header file"></span>

        <div class="subSection">
            Global header file
        </div>

        <p>
            There may be cases where a plugin declares a function or defines a class that we want to be able to use from another plugin. On <a href="https://en.wikipedia.org/wiki/Linux">Linux</a> and <a href="https://en.wikipedia.org/wiki/OS_X">OS X</a>, nothing special needs to be done, but on <a href="https://en.wikipedia.org/wiki/Microsoft_Windows">Windows</a>, the function or class needs to be exported by the original plugin:
        </p>

        <pre class="prettyprint">void __declspec(dllexport) myFunction();
class __declspec(dllexport) myClass;</pre>

        <p>
            and imported by the plugin that wants to use it:
        </p>

        <pre class="prettyprint">void __declspec(dllimport) myFunction();
class __declspec(dllimport) myClass;</pre>

        <p>
            Each plugin that exports functions and/or classes therefore defines a macro that refers either to <code>__declspec(dllexport)</code> or to <code>__declspec(dllimport)</code>, depending on how the plugin's code is to be compiled. Thus, in the case of the <strong>Compiler</strong> plugin, we have:
        </p>

        <pre class="prettyprint">...
#ifdef _WIN32
    #ifdef Compiler_PLUGIN
        #define COMPILER_EXPORT __declspec(dllexport)
    #else
        #define COMPILER_EXPORT __declspec(dllimport)
    #endif
#else
    #define COMPILER_EXPORT
#endif
...</pre>

        <p>
            <code>_WIN32</code> and <code>Compiler_PLUGIN</code> (or, more generally, <code>&lt;PluginName&gt;_PLUGIN</code>) are automatically defined, if at all, at build time, and are used to determine the value of <code>COMPILER_EXPORT</code> (or, more generally, the value of <code>&lt;PLUGINNAME&gt;_EXPORT</code>), which can then be used as follows without having to worry whether the function or class should be imported or exported:
        </p>

        <pre class="prettyprint">void COMPILER_EXPORT myFunction();
class COMPILER_EXPORT myClass;</pre>

        <script type="text/javascript">
            copyright("../../..");
        </script>
    </body>
</html>
